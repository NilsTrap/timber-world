# generated: 2026-01-22
# project: Timber-World
# project_key: producer-mvp
# tracking_system: file-system
# story_location: _bmad-output/implementation-artifacts

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic not yet started
#   - in-progress: Epic actively being worked on
#   - done: All stories in epic completed
#
# Epic Status Transitions:
#   - backlog → in-progress: Automatically when first story is created (via create-story)
#   - in-progress → done: Manually when all stories reach 'done' status
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - ready-for-dev: Story file created in stories folder
#   - in-progress: Developer actively working on implementation
#   - review: Ready for code review (via Dev's code-review workflow)
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - done: Retrospective has been completed
#
# WORKFLOW NOTES:
# ===============
# - Epic transitions to 'in-progress' automatically when first story is created
# - Stories can be worked in parallel if team capacity allows
# - SM typically creates next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', then runs code-review (fresh context, different LLM recommended)

generated: 2026-01-22
project: Timber-World
project_key: producer-mvp
tracking_system: file-system
story_location: _bmad-output/implementation-artifacts

development_status:
  # Epic 1: Portal Foundation & User Access
  epic-1: done
  1-1-portal-app-database-foundation: done
  1-2-user-registration: done
  1-3-user-login-session: done
  1-4-role-based-navigation: done
  1-5-user-profile-management: done
  epic-1-retrospective: optional

  # Epic 2: Admin Inventory Management (Updated for Inventory Data Model v2)
  epic-2: done
  2-1-reference-data-management: done
  2-2-organizations-management: done
  2-3-create-shipment-add-packages: done
  2-4-shipment-inventory-overview: done
  epic-2-retrospective: optional

  # Epic 3: Producer Inventory View
  epic-3: done
  3-1-producer-inventory-table: done
  epic-3-retrospective: optional

  # Epic 4: Production Entry & Tracking
  epic-4: done
  4-1-create-production-entry-with-process-selection: done
  4-2-add-production-inputs-from-inventory: done
  4-3-add-production-outputs: done
  4-4-live-production-calculations: done
  4-5-validate-production-update-inventory: done
  epic-4-retrospective: optional

  # Epic 5: Production Insights & History
  epic-5: done
  5-1-production-page-tabs: done
  5-2-production-corrections: done
  5-3-producer-dashboard-metrics: done
  5-4-admin-efficiency-reports: done
  epic-5-retrospective: optional

  # Epic 6: Multi-Tenancy Foundation
  epic-6: done
  6-1-database-schema-multi-tenancy: done
  6-2-organization-scoped-authentication: done
  6-3-context-aware-inventory-queries: done
  6-4-context-aware-production-queries: done
  6-5-organization-selector-super-admin: done
  epic-6-retrospective: optional

  # Epic 7: User & Organization Management
  epic-7: done
  7-1-enhanced-organizations-management: done
  7-2-user-management-within-organization: done
  7-3-user-credential-generation: done
  7-4-resend-reset-credentials: done
  epic-7-retrospective: optional

  # Epic 8: Inter-Organization Shipments
  epic-8: done
  8-1-shipment-schema-inter-org-flow: done
  8-2-create-shipment-draft: done
  8-3-submit-shipment-for-acceptance: done
  8-4-receiver-reviews-pending-shipment: done
  8-5-accept-or-reject-shipment: done
  8-6-shipment-history-status-tracking: done
  epic-8-retrospective: optional

  # Epic 9: Consolidated Platform Views
  epic-9: done
  9-1-super-admin-aggregated-dashboard: done
  9-2-per-organization-breakdown: done
  9-3-all-shipments-view: done
  9-4-organization-user-shipments-view: done
  epic-9-retrospective: optional

# ============================================================================
# AD-HOC CHANGES LOG
# ============================================================================
# Changes made outside of formal story tracking, typically UX improvements,
# bug fixes, or minor enhancements requested during development.

ad_hoc_changes:
  - date: 2026-01-26
    description: "Super Admin delete capabilities and navigation restructure"
    changes:
      - "Super Admin can delete production history entries (from detail page and list view)"
      - "Super Admin can delete inventory packages (from admin inventory page)"
      - "Super Admin can delete shipments (from shipments list)"
      - "Super Admin can delete reference data options (from reference data page)"
      - "Navigation restructure: Renamed 'New Shipment' to 'Shipments' page"
      - "Shipments page now has two tabs: 'New Shipment' and 'Shipments' list"
      - "Inventory page simplified to show only packages (removed Shipments tab)"
    files_created:
      - "src/app/(portal)/admin/shipments/page.tsx"
      - "src/features/shipments/components/ShipmentsPageContent.tsx"
      - "src/features/shipments/actions/deleteShipment.ts"
      - "src/features/inventory/actions/deleteInventoryPackage.ts"
      - "src/features/reference-data/actions/deleteReferenceOption.ts"
    files_modified:
      - "src/features/production/actions/deleteProductionEntry.ts"
      - "src/features/production/components/ProductionHistoryTable.tsx"
      - "src/features/production/components/ProductionPageTabs.tsx"
      - "src/app/(portal)/production/page.tsx"
      - "src/features/shipments/components/PackagesTab.tsx"
      - "src/features/shipments/components/ShipmentsTab.tsx"
      - "src/features/shipments/components/InventoryOverview.tsx"
      - "src/features/reference-data/components/ReferenceOptionsTable.tsx"
      - "src/features/reference-data/components/ReferenceDataManager.tsx"
      - "src/app/(portal)/admin/reference/page.tsx"
      - "src/app/(portal)/admin/inventory/page.tsx"
      - "src/components/layout/SidebarWrapper.tsx"
      - "packages/ui/src/components/data-entry-table.tsx"

  - date: 2026-01-26
    description: "Producer Shipments page redesign to match Admin layout"
    changes:
      - "Producer /shipments page now uses same layout as Admin (New Shipment tab + Shipments tab)"
      - "New Shipment form uses admin's PackageEntryTable with locked 'From' organisation"
      - "Shipments tab shows combined outgoing + incoming history with direction badges"
      - "Direction filter buttons (All / Outgoing / Incoming) for quick filtering"
      - "Status badges show shipment workflow state (Draft, Pending, Completed, etc.)"
    files_created:
      - "src/features/shipments/actions/createOrgShipment.ts"
      - "src/features/shipments/actions/getAllOrgShipments.ts"
      - "src/features/shipments/actions/getUserOrganisation.ts"
      - "src/features/shipments/components/ProducerNewShipmentForm.tsx"
      - "src/features/shipments/components/ProducerShipmentsTab.tsx"
      - "src/features/shipments/components/ProducerShipmentsPageContent.tsx"
    files_modified:
      - "src/features/shipments/components/ShipmentHeader.tsx"
      - "src/features/shipments/actions/index.ts"
      - "src/features/shipments/components/index.ts"
      - "src/app/(portal)/shipments/page.tsx"

  - date: 2026-01-27
    description: "Admin inventory inline editing with organisation dropdown and manual save"
    changes:
      - "Admin inventory view now supports inline editing with Save/Discard buttons (no auto-save)"
      - "Organisation dropdown shows 3-letter code in cell but full 'CODE - Name' in dropdown menu"
      - "Add/Copy row buttons: copy preserves shipmentCode and packageNumber (only clears shipmentId)"
      - "Removed 'Add Inventory' tab - editing merged into main inventory view"
      - "Fixed organisation filter sidebar not updating inventory display (useEffect sync)"
      - "Fixed shipment code 'ADMIN' not showing (separate shipment query instead of JOIN)"
      - "Shipment code uniqueness restored with exceptions for 'ADMIN', '-', and empty string"
    files_created:
      - "src/features/inventory/actions/saveInventoryPackages.ts"
      - "supabase/migrations/20260127000002_allow_duplicate_shipment_codes.sql"
      - "supabase/migrations/20260127000003_restore_shipment_code_uniqueness.sql"
    files_modified:
      - "src/features/inventory/components/EditablePackagesTab.tsx"
      - "src/features/inventory/components/AdminInventoryPageContent.tsx"
      - "src/features/inventory/actions/getEditablePackages.ts"
      - "src/features/inventory/actions/updateShipmentCode.ts"
    files_deleted:
      - "src/features/inventory/components/AdminAddInventoryForm.tsx"
    database_changes:
      - "Unique index on shipments.shipment_code now excludes 'ADMIN', '-', and empty string"

  - date: 2026-01-28
    description: "DataEntryTable UX improvements and production outputs shipment code"
    changes:
      - "Added shipment code column to validated production outputs (read-only mode only)"
      - "Fixed package selector hover colors: selected rows now use bg-accent/30 hover:bg-accent/40"
      - "Added DataEntryTable imperative handle with clearFilters() method for external control"
      - "Added onFilterActiveChange callback to track filter state externally"
      - "Implemented column width locking to prevent table jumping when filtering"
      - "Added displayName to DataEntryTable forwardRef for React DevTools"
      - "Table component now supports ref forwarding to inner table element"
      - "Clear Filters button in inventory views positioned at bottom-right of summary cards"
      - "Inventory view containers use w-fit max-w-full for proper responsive behavior"
      - "Standardized collapse/expand icons to use › and ‹ consistently"
    files_modified:
      - "packages/ui/src/components/data-entry-table.tsx"
      - "packages/ui/src/components/table.tsx"
      - "packages/ui/src/index.ts"
      - "apps/portal/src/features/inventory/components/ProducerInventory.tsx"
      - "apps/portal/src/features/inventory/components/AdminInventoryViewTab.tsx"
      - "apps/portal/src/features/production/components/PackageSelector.tsx"
      - "apps/portal/src/features/production/components/ProductionOutputsTable.tsx"
      - "apps/portal/src/features/production/components/ProductionOutputsSection.tsx"
      - "apps/portal/src/features/production/actions/getProductionOutputs.ts"
      - "apps/portal/src/features/production/types.ts"
      - "apps/portal/src/features/production/helpers/output-helpers.ts"

  - date: 2026-01-28
    description: "Fix user invitation cascade delete bug"
    changes:
      - "Fixed bug where resending invitation deleted portal_user record"
      - "Changed portal_users.auth_user_id FK from ON DELETE CASCADE to ON DELETE SET NULL"
    files_created:
      - "supabase/migrations/20260128000001_fix_auth_user_cascade.sql"

  - date: 2026-01-28
    description: "Lookup-based package number assignment for production outputs"
    changes:
      - "Replaced counter-based package numbering with lookup approach"
      - "Package numbers now assigned manually via 'Assign Package Numbers' button"
      - "Lookup checks both inventory_packages and portal_production_outputs for max number"
      - "Removed 'pending' placeholder from new output rows"
      - "Made package_number nullable in portal_production_outputs"
      - "Added sort_order column to preserve row ordering"
    files_created:
      - "apps/portal/src/features/production/actions/assignPackageNumbers.ts"
      - "supabase/migrations/20260128000002_nullable_package_number.sql"
    files_modified:
      - "apps/portal/src/features/production/actions/saveProductionOutputs.ts"
      - "apps/portal/src/features/production/components/ProductionOutputsSection.tsx"
      - "apps/portal/src/features/production/helpers/output-helpers.ts"

  - date: 2026-01-30
    description: "Package number assignment fixes and admin inventory improvements"
    changes:
      - "Fixed table names in assignPackageNumbers action (portal_production_entries, portal_production_outputs)"
      - "Fixed delete draft redirect to go to active tab instead of history tab"
      - "Made package_sequence nullable for admin-added inventory packages"
    files_created:
      - "supabase/migrations/20260130000001_nullable_package_sequence.sql"
    files_modified:
      - "apps/portal/src/features/production/actions/assignPackageNumbers.ts"
      - "apps/portal/src/features/production/components/DeleteDraftButton.tsx"
    database_changes:
      - "inventory_packages.package_sequence now nullable (for admin-added packages without shipment)"
