# generated: 2026-01-22
# project: Timber-World
# project_key: producer-mvp
# tracking_system: file-system
# story_location: _bmad-output/implementation-artifacts

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic not yet started
#   - in-progress: Epic actively being worked on
#   - done: All stories in epic completed
#
# Epic Status Transitions:
#   - backlog → in-progress: Automatically when first story is created (via create-story)
#   - in-progress → done: Manually when all stories reach 'done' status
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - ready-for-dev: Story file created in stories folder
#   - in-progress: Developer actively working on implementation
#   - review: Ready for code review (via Dev's code-review workflow)
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - done: Retrospective has been completed
#
# WORKFLOW NOTES:
# ===============
# - Epic transitions to 'in-progress' automatically when first story is created
# - Stories can be worked in parallel if team capacity allows
# - SM typically creates next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', then runs code-review (fresh context, different LLM recommended)

generated: 2026-01-22
project: Timber-World
project_key: producer-mvp
tracking_system: file-system
story_location: _bmad-output/implementation-artifacts

development_status:
  # Epic 1: Portal Foundation & User Access
  epic-1: done
  1-1-portal-app-database-foundation: done
  1-2-user-registration: done
  1-3-user-login-session: done
  1-4-role-based-navigation: done
  1-5-user-profile-management: done
  epic-1-retrospective: optional

  # Epic 2: Admin Inventory Management (Updated for Inventory Data Model v2)
  epic-2: done
  2-1-reference-data-management: done
  2-2-organizations-management: done
  2-3-create-shipment-add-packages: done
  2-4-shipment-inventory-overview: done
  epic-2-retrospective: optional

  # Epic 3: Producer Inventory View
  epic-3: done
  3-1-producer-inventory-table: done
  epic-3-retrospective: optional

  # Epic 4: Production Entry & Tracking
  epic-4: done
  4-1-create-production-entry-with-process-selection: done
  4-2-add-production-inputs-from-inventory: done
  4-3-add-production-outputs: done
  4-4-live-production-calculations: done
  4-5-validate-production-update-inventory: done
  epic-4-retrospective: optional

  # Epic 5: Production Insights & History
  epic-5: done
  5-1-production-page-tabs: done
  5-2-production-corrections: done
  5-3-producer-dashboard-metrics: done
  5-4-admin-efficiency-reports: done
  epic-5-retrospective: optional

  # Epic 6: Multi-Tenancy Foundation
  epic-6: done
  6-1-database-schema-multi-tenancy: done
  6-2-organization-scoped-authentication: done
  6-3-context-aware-inventory-queries: done
  6-4-context-aware-production-queries: done
  6-5-organization-selector-super-admin: done
  epic-6-retrospective: optional

  # Epic 7: User & Organization Management
  epic-7: done
  7-1-enhanced-organizations-management: done
  7-2-user-management-within-organization: done
  7-3-user-credential-generation: done
  7-4-resend-reset-credentials: done
  epic-7-retrospective: optional

  # Epic 8: Inter-Organization Shipments
  epic-8: done
  8-1-shipment-schema-inter-org-flow: done
  8-2-create-shipment-draft: done
  8-3-submit-shipment-for-acceptance: done
  8-4-receiver-reviews-pending-shipment: done
  8-5-accept-or-reject-shipment: done
  8-6-shipment-history-status-tracking: done
  epic-8-retrospective: optional

  # Epic 9: Consolidated Platform Views
  epic-9: done
  9-1-super-admin-aggregated-dashboard: done
  9-2-per-organization-breakdown: done
  9-3-all-shipments-view: done
  9-4-organization-user-shipments-view: done
  epic-9-retrospective: optional

  # Epic 10: Platform Foundation v2 (Multi-Org Upgrade)
  # NOTE: This epic EVOLVES Epics 6-7 (not replaces). See epics.md for relationship mapping.
  # Implemented: 2026-02-01
  epic-10: done
  10-1-database-schema-core-tables: done
  10-2-seed-organization-types: done
  10-3-seed-features-registry: done
  10-4-seed-default-roles: done
  10-5-migrate-users-to-memberships: done
  10-6-update-session-context: done
  10-7-organization-switcher-ui: done
  10-8-permission-checking-infrastructure: done
  10-9-role-management-ui: done
  10-10-user-role-assignment: done  # Backend ready, UI in org detail page pending
  10-11-user-permission-overrides: done  # Backend ready, UI in org detail page pending
  10-12-organization-feature-configuration: done  # Backend ready, UI in org detail page pending
  10-13-organization-type-management: done  # Backend ready, UI in org detail page pending
  10-14-view-as-organization-impersonation: done
  10-15-view-as-user-impersonation: done
  10-16-audit-trail-for-impersonation: done
  epic-10-retrospective: optional

# ============================================================================
# AD-HOC CHANGES LOG
# ============================================================================
# Changes made outside of formal story tracking, typically UX improvements,
# bug fixes, or minor enhancements requested during development.

ad_hoc_changes:
  - date: 2026-01-26
    description: "Super Admin delete capabilities and navigation restructure"
    changes:
      - "Super Admin can delete production history entries (from detail page and list view)"
      - "Super Admin can delete inventory packages (from admin inventory page)"
      - "Super Admin can delete shipments (from shipments list)"
      - "Super Admin can delete reference data options (from reference data page)"
      - "Navigation restructure: Renamed 'New Shipment' to 'Shipments' page"
      - "Shipments page now has two tabs: 'New Shipment' and 'Shipments' list"
      - "Inventory page simplified to show only packages (removed Shipments tab)"
    files_created:
      - "src/app/(portal)/admin/shipments/page.tsx"
      - "src/features/shipments/components/ShipmentsPageContent.tsx"
      - "src/features/shipments/actions/deleteShipment.ts"
      - "src/features/inventory/actions/deleteInventoryPackage.ts"
      - "src/features/reference-data/actions/deleteReferenceOption.ts"
    files_modified:
      - "src/features/production/actions/deleteProductionEntry.ts"
      - "src/features/production/components/ProductionHistoryTable.tsx"
      - "src/features/production/components/ProductionPageTabs.tsx"
      - "src/app/(portal)/production/page.tsx"
      - "src/features/shipments/components/PackagesTab.tsx"
      - "src/features/shipments/components/ShipmentsTab.tsx"
      - "src/features/shipments/components/InventoryOverview.tsx"
      - "src/features/reference-data/components/ReferenceOptionsTable.tsx"
      - "src/features/reference-data/components/ReferenceDataManager.tsx"
      - "src/app/(portal)/admin/reference/page.tsx"
      - "src/app/(portal)/admin/inventory/page.tsx"
      - "src/components/layout/SidebarWrapper.tsx"
      - "packages/ui/src/components/data-entry-table.tsx"

  - date: 2026-01-26
    description: "Producer Shipments page redesign to match Admin layout"
    changes:
      - "Producer /shipments page now uses same layout as Admin (New Shipment tab + Shipments tab)"
      - "New Shipment form uses admin's PackageEntryTable with locked 'From' organisation"
      - "Shipments tab shows combined outgoing + incoming history with direction badges"
      - "Direction filter buttons (All / Outgoing / Incoming) for quick filtering"
      - "Status badges show shipment workflow state (Draft, Pending, Completed, etc.)"
    files_created:
      - "src/features/shipments/actions/createOrgShipment.ts"
      - "src/features/shipments/actions/getAllOrgShipments.ts"
      - "src/features/shipments/actions/getUserOrganisation.ts"
      - "src/features/shipments/components/ProducerNewShipmentForm.tsx"
      - "src/features/shipments/components/ProducerShipmentsTab.tsx"
      - "src/features/shipments/components/ProducerShipmentsPageContent.tsx"
    files_modified:
      - "src/features/shipments/components/ShipmentHeader.tsx"
      - "src/features/shipments/actions/index.ts"
      - "src/features/shipments/components/index.ts"
      - "src/app/(portal)/shipments/page.tsx"

  - date: 2026-01-27
    description: "Admin inventory inline editing with organisation dropdown and manual save"
    changes:
      - "Admin inventory view now supports inline editing with Save/Discard buttons (no auto-save)"
      - "Organisation dropdown shows 3-letter code in cell but full 'CODE - Name' in dropdown menu"
      - "Add/Copy row buttons: copy preserves shipmentCode and packageNumber (only clears shipmentId)"
      - "Removed 'Add Inventory' tab - editing merged into main inventory view"
      - "Fixed organisation filter sidebar not updating inventory display (useEffect sync)"
      - "Fixed shipment code 'ADMIN' not showing (separate shipment query instead of JOIN)"
      - "Shipment code uniqueness restored with exceptions for 'ADMIN', '-', and empty string"
    files_created:
      - "src/features/inventory/actions/saveInventoryPackages.ts"
      - "supabase/migrations/20260127000002_allow_duplicate_shipment_codes.sql"
      - "supabase/migrations/20260127000003_restore_shipment_code_uniqueness.sql"
    files_modified:
      - "src/features/inventory/components/EditablePackagesTab.tsx"
      - "src/features/inventory/components/AdminInventoryPageContent.tsx"
      - "src/features/inventory/actions/getEditablePackages.ts"
      - "src/features/inventory/actions/updateShipmentCode.ts"
    files_deleted:
      - "src/features/inventory/components/AdminAddInventoryForm.tsx"
    database_changes:
      - "Unique index on shipments.shipment_code now excludes 'ADMIN', '-', and empty string"

  - date: 2026-01-28
    description: "DataEntryTable UX improvements and production outputs shipment code"
    changes:
      - "Added shipment code column to validated production outputs (read-only mode only)"
      - "Fixed package selector hover colors: selected rows now use bg-accent/30 hover:bg-accent/40"
      - "Added DataEntryTable imperative handle with clearFilters() method for external control"
      - "Added onFilterActiveChange callback to track filter state externally"
      - "Implemented column width locking to prevent table jumping when filtering"
      - "Added displayName to DataEntryTable forwardRef for React DevTools"
      - "Table component now supports ref forwarding to inner table element"
      - "Clear Filters button in inventory views positioned at bottom-right of summary cards"
      - "Inventory view containers use w-fit max-w-full for proper responsive behavior"
      - "Standardized collapse/expand icons to use › and ‹ consistently"
    files_modified:
      - "packages/ui/src/components/data-entry-table.tsx"
      - "packages/ui/src/components/table.tsx"
      - "packages/ui/src/index.ts"
      - "apps/portal/src/features/inventory/components/ProducerInventory.tsx"
      - "apps/portal/src/features/inventory/components/AdminInventoryViewTab.tsx"
      - "apps/portal/src/features/production/components/PackageSelector.tsx"
      - "apps/portal/src/features/production/components/ProductionOutputsTable.tsx"
      - "apps/portal/src/features/production/components/ProductionOutputsSection.tsx"
      - "apps/portal/src/features/production/actions/getProductionOutputs.ts"
      - "apps/portal/src/features/production/types.ts"
      - "apps/portal/src/features/production/helpers/output-helpers.ts"

  - date: 2026-01-28
    description: "Fix user invitation cascade delete bug"
    changes:
      - "Fixed bug where resending invitation deleted portal_user record"
      - "Changed portal_users.auth_user_id FK from ON DELETE CASCADE to ON DELETE SET NULL"
    files_created:
      - "supabase/migrations/20260128000001_fix_auth_user_cascade.sql"

  - date: 2026-01-28
    description: "Lookup-based package number assignment for production outputs"
    changes:
      - "Replaced counter-based package numbering with lookup approach"
      - "Package numbers now assigned manually via 'Assign Package Numbers' button"
      - "Lookup checks both inventory_packages and portal_production_outputs for max number"
      - "Removed 'pending' placeholder from new output rows"
      - "Made package_number nullable in portal_production_outputs"
      - "Added sort_order column to preserve row ordering"
    files_created:
      - "apps/portal/src/features/production/actions/assignPackageNumbers.ts"
      - "supabase/migrations/20260128000002_nullable_package_number.sql"
    files_modified:
      - "apps/portal/src/features/production/actions/saveProductionOutputs.ts"
      - "apps/portal/src/features/production/components/ProductionOutputsSection.tsx"
      - "apps/portal/src/features/production/helpers/output-helpers.ts"

  - date: 2026-02-01
    description: "Epic 10: Platform Foundation v2 - Multi-Org Architecture"
    changes:
      - "Database: 9 new tables (organization_types, organization_type_assignments, organization_relationships, organization_memberships, features, organization_features, roles, user_roles, user_permission_overrides, audit_log)"
      - "Database: is_platform_admin column on portal_users"
      - "Database: 6 organization types seeded (Principal, Producer, Supplier, Client, Trader, Logistics)"
      - "Database: 40+ platform features seeded by category"
      - "Database: 5 default roles seeded (Full Access, Org Admin, Production Manager, Inventory Manager, Viewer)"
      - "Session: Enhanced with memberships array, currentOrganizationId, viewAs context"
      - "Auth: 3-layer permission model (Organization Features → Roles → User Overrides)"
      - "Auth: hasPermission(), getEffectivePermissions(), requirePermission() functions"
      - "Auth: usePermissions() client-side hook"
      - "UI: OrganizationSwitcher component for multi-org users"
      - "UI: Roles management page (/admin/roles) with CRUD"
      - "UI: View-As banner and selector for platform admin impersonation"
      - "Fixes: Explicit FK hints for PostgREST queries (PGRST201 ambiguity)"
      - "Fixes: Backward compatibility for isSuperAdmin check"
    files_created:
      - "supabase/migrations/20260201000001_epic10_core_tables.sql"
      - "supabase/migrations/20260201000002_epic10_seed_org_types.sql"
      - "supabase/migrations/20260201000003_epic10_seed_features.sql"
      - "supabase/migrations/20260201000004_epic10_seed_roles.sql"
      - "supabase/migrations/20260201000005_epic10_migrate_users.sql"
      - "apps/portal/src/lib/auth/permissions.ts"
      - "apps/portal/src/lib/auth/usePermissions.ts"
      - "apps/portal/src/app/api/auth/permissions/route.ts"
      - "apps/portal/src/app/api/auth/switch-organization/route.ts"
      - "apps/portal/src/components/layout/OrganizationSwitcher.tsx"
      - "apps/portal/src/features/roles/*"
      - "apps/portal/src/features/view-as/*"
      - "apps/portal/src/app/(portal)/admin/roles/page.tsx"
      - "packages/ui/src/components/checkbox.tsx"
    files_modified:
      - "apps/portal/src/lib/auth/getSession.ts"
      - "apps/portal/src/lib/auth/index.ts"
      - "apps/portal/src/components/layout/Sidebar.tsx"
      - "apps/portal/src/components/layout/SidebarWrapper.tsx"
      - "apps/portal/src/components/layout/SidebarLink.tsx"
      - "apps/portal/src/app/(portal)/layout.tsx"
      - "apps/portal/src/features/organisations/actions/getOrganisations.ts"
      - "apps/portal/src/features/organisations/actions/getOrganisationById.ts"
      - "apps/portal/src/features/inventory/actions/getProducerPackages.ts"
      - "apps/portal/src/features/dashboard/actions/getProducerMetrics.ts"
      - "apps/portal/src/features/dashboard/actions/getAdminMetrics.ts"
      - "packages/ui/src/index.ts"
      - "packages/ui/package.json"

  - date: 2026-01-30
    description: "Package number assignment fixes and admin inventory improvements"
    changes:
      - "Fixed table names in assignPackageNumbers action (portal_production_entries, portal_production_outputs)"
      - "Fixed delete draft redirect to go to active tab instead of history tab"
      - "Made package_sequence nullable for admin-added inventory packages"
    files_created:
      - "supabase/migrations/20260130000001_nullable_package_sequence.sql"
    files_modified:
      - "apps/portal/src/features/production/actions/assignPackageNumbers.ts"
      - "apps/portal/src/features/production/components/DeleteDraftButton.tsx"
    database_changes:
      - "inventory_packages.package_sequence now nullable (for admin-added packages without shipment)"

  - date: 2026-02-02
    description: "Security, validation, and print functionality improvements"
    changes:
      - "Session verification per browser window: Users must log in when opening new browser windows/tabs (uses sessionStorage)"
      - "Login form autofill: Added proper form attributes for password manager support"
      - "Production delete cleanup: Package numbers are now properly cleaned up when deleting validated production entries"
      - "Output field validation: Prevent validation of production entries with incomplete output fields (product, species, humidity, type, processing, FSC, quality, dimensions, pieces/volume)"
      - "Inventory print button: Print functionality respects current filters, landscape mode with 10pt font"
      - "Production outputs print button: Print button for both draft and validated (history) production outputs"
      - "Fixed unexpected logouts: Added hasChecked ref to prevent repeated session verification on navigation"
    files_created:
      - "apps/portal/src/components/SessionVerificationGuard.tsx"
      - "apps/portal/src/features/inventory/components/PrintInventoryButton.tsx"
      - "apps/portal/src/features/production/components/PrintOutputsButton.tsx"
    files_modified:
      - "apps/portal/src/app/(portal)/layout.tsx"
      - "apps/portal/src/features/auth/components/LoginForm.tsx"
      - "apps/portal/src/features/production/actions/deleteProductionEntry.ts"
      - "apps/portal/src/features/production/actions/validateProduction.ts"
      - "apps/portal/src/features/inventory/components/ProducerInventory.tsx"
      - "apps/portal/src/features/inventory/components/AdminInventoryViewTab.tsx"
      - "apps/portal/src/features/production/components/ProductionOutputsSection.tsx"
      - "apps/portal/src/features/production/components/ProductionEntryClient.tsx"

  - date: 2026-02-02
    description: "Organization-specific process notes with print functionality"
    changes:
      - "Producers can add their own descriptions/explanations for each production process"
      - "Notes are stored per-organization (each producer sees their own notes)"
      - "Inline editing with Ctrl+Enter to save, Escape to cancel"
      - "Print button to print processes with descriptions for posting on walls"
      - "Added Textarea component to @timber/ui package"
    files_created:
      - "supabase/migrations/20260202000001_organization_process_notes.sql"
      - "apps/portal/src/features/production/actions/saveProcessNote.ts"
      - "apps/portal/src/features/production/components/PrintProcessesButton.tsx"
      - "packages/ui/src/components/textarea.tsx"
    files_modified:
      - "apps/portal/src/app/(portal)/production/page.tsx"
      - "apps/portal/src/features/production/actions/getProcesses.ts"
      - "apps/portal/src/features/production/actions/index.ts"
      - "apps/portal/src/features/production/components/ProcessesTab.tsx"
      - "apps/portal/src/features/production/components/ProductionPageTabs.tsx"
      - "apps/portal/src/features/production/types.ts"
      - "packages/ui/src/index.ts"
    database_changes:
      - "New table: organization_process_notes (id, organization_id, process_id, notes, created_at, updated_at)"
      - "RLS policies for organization-scoped access"

  - date: 2026-02-02
    description: "Rename production page tabs for clarity"
    changes:
      - "Active → Drafts (shows new production form + draft entries)"
      - "History → Completed (shows validated production entries)"
      - "Processes → Process List (shows process codes with notes)"
    files_modified:
      - "apps/portal/src/features/production/components/ProductionPageTabs.tsx"
      - "apps/portal/src/features/production/actions/getProcesses.ts"
